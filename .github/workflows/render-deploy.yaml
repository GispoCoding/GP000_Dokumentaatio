name: Render to HTML & Deploy
on:
  repository_dispatch:
    types: [render-deploy]

jobs:
  check-changes:
    name: Check if Rmd or image files changed
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Render modified courses to HTML and move output to docs
        env:
          CHANGED_COURSES: ${{ github.event.client_payload.CHANGED_COURSES }}
        run: |
          export WORKFLOW=true

          for folder in ${CHANGED_COURSES}; do
            code="${folder#src/}"
            ./render.sh $code
          done

          cp ./assets/favicon.ico ./docs/favicon.ico
          cp ./assets/index.html ./docs/index.html

      - name: Add, Commit & Push
        env:
          CHANGED_COURSES: ${{ github.event.client_payload.CHANGED_COURSES }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout --orphan temp-pages

          git rm -r --cached .

          git checkout remotes/origin/pages -- ./G*

          for folder in ${CHANGED_COURSES}; do
            code="${folder#src/}"
            rm -rf $code
          done

          git add G*

          git add docs
          git clean -df

          mv docs/* .
          rm -r docs

          git add .
          git commit -m "Automatic: Render docs from ${GITHUB_SHA}"

          git branch -M temp-pages pages

          git push --force origin pages

